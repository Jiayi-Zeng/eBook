{% extends "base_home.html" %}

{% load wagtailcore_tags static %}

{% block content %}

{% if publish_objects %}
<div class="tab-example-result">
    {% for publish_object in publish_objects %}
    <div id="accordion-{{ forloop.counter }}" class="accordion accordion-stacked">
        <!-- Accordion card 1 -->
        <div class="card">
            <div class="card-header py-4" id="heading-{{ forloop.counter }}-{{ forloop.counter }}"
                data-toggle="collapse" role="button" data-target="#collapse-{{ forloop.counter }}-{{ forloop.counter }}"
                aria-expanded="false" aria-controls="collapse-{{ forloop.counter }}-{{ forloop.counter }}">
                <h6 class="mb-0"><i data-feather="file" class="mr-3"></i>Question #{{ forloop.counter }}
                </h6>
            </div>
            <div id="collapse-{{ forloop.counter }}-{{ forloop.counter }}" class="collapse"
                aria-labelledby="heading-{{ forloop.counter }}-{{ forloop.counter }}"
                data-parent="#accordion-{{ forloop.counter }}">
                <div class="card-body">

                    
                    <div class="container position-relative zindex-100">
                        <div class="row justify-content-center">
                            <div class="col-lg-6 text-center">
                                <h3>Question #{{ forloop.counter }}</h3>
                                <p class="lh-190">{{ publish_object.question.question_text }}</p>
                            </div>
                        </div>
                        <div class="row justify-content-center">
                            <div class="col-lg-6">
                                {% if publish_object.publish_id in answered_publish %}
                                <div class="row justify-content-center">
                                    <p>You've already answered this question.</p>
                                </div>
                                <!-- <p>Your answer is {{ answered_choice }}. Please wait the end of the publish.</p> -->
                                {% else %}
                                <!-- Form -->
                                <form action="{% url 'polls:vote' publish_object.publish_id%}" method="post">
                                    {% csrf_token %}
                                    {% for choice in publish_object.question.choices.all %}
                                    <div class="custom-control custom-radio">
                                        <input type="radio" name="choice" id="choice{{ forloop.counter }}" value="{{ choice.id }}" class="custom-control-input">
                                        <label class="custom-control-label" for="choice{{ forloop.counter }}">{{ choice.choice_text }}</label>
                                    </div>
                                    {% endfor %}
                                    <div class="text-center">
                                        <button type="submit" value="Vote" class="btn btn-block btn-lg btn-primary mt-4">Submit</button>
                                    </div>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
{% if error_message %}
<p><strong>{{ error_message }}</strong></p>
{% else %}
<p>No questions are available now.</p>
{% endif %}
{% endif %}


{% endblock %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="card" id="chat2" style="height: 100%;">
        <div class="card-header d-flex justify-content-between align-items-center p-3">
            <h5 class="mb-0">Chat</h5>
        </div>
        <div class="card-body" id="history" data-mdb-perfect-scrollbar="true" style="position: relative; height: 400px; overflow: auto;">
            <!-- Messages will be displayed here -->
            <p>{{ context.conversation }}</p>
        </div>
        <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
            <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 3"
                style="width: 40px; height: 100%;">
            <input type="text" class="form-control form-control-lg" id="message"
                placeholder="Type message">
            <a class="ms-1 text-muted" href="#!"><i class="fas fa-paperclip"></i></a>
            <a class="ms-3 text-muted" href="#!"><i class="fas fa-smile"></i></a>
            <a class="ms-3" href="#!"><i class="fas fa-paper-plane"></i></a>
        </div>
    </div>

    <!-- Include your JavaScript code here -->
    <script>
        // Access the conversation data directly from the Django view
        var conversationData = [
            { "role": "system", "content": "You are a helpful assistant." },
            { "role": "user", "content": "Who won the world series in 2020?" },
            { "role": "assistant", "content": "The Los Angeles Dodgers won the World Series in 2020." },
            { "role": "user", "content": "Where was it played?" }
        ];

        $(document).ready(function () {
            // Function to display a chat message
            function displayMessage(role, content) {
                var history = $('#history'); // Target the history element by ID
                var messageHtml = '';

                if (role === 'user') {
                    messageHtml += '<div class="d-flex flex-row justify-content-start mb-4">';
                    messageHtml += '<img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">';
                    messageHtml += '<div>';
                    messageHtml += '<p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">' + content + '</p>';
                    messageHtml += '</div>';
                    messageHtml += '</div>';
                } else if (role === 'assistant') {
                    messageHtml += '<div class="d-flex flex-row justify-content-end mb-4">';
                    messageHtml += '<div>';
                    messageHtml += '<p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">' + content + '</p>';
                    messageHtml += '<p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:06</p>';
                    messageHtml += '</div>';
                    messageHtml += '<img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">';
                    messageHtml += '</div>';
                } else {
                    // Handle other roles (e.g., system) as needed
                }

                history.append(messageHtml);

                // Scroll to the bottom of the history element to show the latest message
                history.scrollTop(history[0].scrollHeight);
            }

            // Iterate through conversation data and display messages
            conversationData.forEach(function (message) {
                displayMessage(message.role, message.content);
            });

            $('#chat-form').submit(function (event) {
                event.preventDefault();
                $.ajax({
                    url: '/chat/',
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function (data) {
                        // Display user's message
                        displayMessage('user', $('#message').val());

                        // Display bot's response
                        displayMessage('assistant', data.bot_response);

                        $('#message').val('');
                    }
                });
            });
        });
    </script>
</body>
<!-- </html> -->
