# 3.1 程序运行

## 3.1.1 CPU内存结构

![图3.1.1 计算机系统逻辑结构](https://ebook2023.oss-cn-shanghai.aliyuncs.com/图3.1.1 计算机系统逻辑结构.png)

在第一章中，我们已经介绍了计算机的硬件组成，计算机系统的输入会以数据或者程序的形式存放在存储器中（外存或内存，而最终外存信息也将被加载进入内存），CPU从内存加载程序、执行程序，在此过程中与内存进行数据交换，并将最总计算机结果存入内存，再通过系统进行输出。从这个过程，我们可以看到，计算机最核心的部分是CPU和内存，因此我们在讲解计算机系统的时候，往往忽略输入、输出部分，聚焦在CPU和内存之上。

![图3.1.2 简化的计算机系统逻辑结构，仅含内存和CPU部分](https://ebook2023.oss-cn-shanghai.aliyuncs.com/图3.1.2 简化的计算机系统逻辑结构，仅含内存和CPU部分.png) 

### 1. 内存

内存条，我们电脑中的内存条，它是属于内部存储器，主要就是用来存放数据的，也可以理解为我们这里说的内存，这是实际存在的，我们可以看得见的内存条，但是关于数据存储，怎么存储，我们抽象点儿来说，这个内存其实就是一个个的小格子，如图3.1.3所示。

![图3.1.3 内存逻辑结构图](https://ebook2023.oss-cn-shanghai.aliyuncs.com/图3.1.3 内存逻辑结构图.png)

这些小格子就是用来存放数据和指令的，而且每个格子都有自己的编号，这个编号大家也熟悉，就是我们经常说的内存地址。可以形象的来打个比喻，内存就像同学们的寝室，每个寝室都有一个唯一的门牌号，也就是内存地址，通过这个编号，我们可以唯一的来访问每个房间；同时，为了管理方便我们要求这个编号是有顺序的，也就是说相邻编号的寝室也是相邻的，寝室大小完全一致，每个寝室能装的学生数量是完全一样的，计算机是只认识0和1的，所以存放在内存中的数据其实都是二进制文件了。为什么要这样来要求呢，简单的结构往往控制起来特别容易，如果每个格子大小不一样，我们还得记住每个格子的大小，而如果格子大小一样，我们就可以设置一个默认值，大家统一按照这个规则来执行就行，内存格子的大小往往与计算机数据带宽一致，比如16位计算机内存块可以放16个bit二进制数，64位计算机内存块可以放64个bit数据，大家可以想想为什么这么来设置。另外，由于地址是连续的，这样我们知道一个地址号，比如210号寝室，它前续或后续的房间位置就完全确定了。这样设计，还有另外一个好处，就是所需要存储的数据块大于一个格子的容量时，我们只需要简单将这个数据块房放在相邻的几个格子里即可，方便存取。

### 2. CPU

CPU是计算机的大脑，它最大的特点是数据读写的速度特别快，这是内存和硬盘根本没法比。现代CPU执行一条指令大约需要耗时1ns，但是对于内存呢？它去硬盘读取数据至少8ms，在这段时间内，CPU可以执行大约800万条指令。

就像《码农翻身》一书中说的那样：CPU的运算速度快的丧心病狂，但是它能做的事情简单的令人发指。别看CPU那么牛，那么复杂，那么快，它做的事情真的挺无聊的，总结起来，CPU主要就干如下四件事情：

* 从内存中读取数据，然后放到寄存器中

* 把寄存器中的数据写入到内存

* 进行数学运算和逻辑运算（加减乘除，AND,OR）

* 依据相应的条件进行跳转，执行其他指令（一条指令跳转到另外一条指令）

CPU其实是由一些列器件组成，我们先介绍寄存器和运算器。

**寄存器**，说白了就是存放数据的，是个存储部件，还记得之前说内存就是一个个的小格子吗？这个寄存器你就可以简单的想成也是小格子（内存），放数据的。但与内存不一样的是，寄存器是存储部件，容量非常有限，能存储的数据的大小，现在来说一般有两种，也就是我们常听说的32位和64位，32位的寄存器就能存储4个字节的数据，64位的寄存器就能存储8个字节的数据，另外CPU也分为32位和64位其实就是由其中的寄存器的位数决定的，可想而知，即使是64位的寄存器也干不了啥大事，所以，现在的CPU一般都内置了很多的寄存器，依此来完成比较复杂的操作。

**运算器**是计算的核心，主要的作用就是用来做加减乘除这些运算的，不过，这里你需要知道的一点就是，运算器是没法直接操作内存中的数据的，很容易想到，运算器操作的数据是寄存器中存放的数据。

>**选择题 3.1.1 存储单元中存储内容。**
>在计算机的存储单元中存储的（）。
>
>* 只能是数据
>* 只能是字符
>* 只能是指令
>* 可以是数据或指令
>
>正确答案：可以是数据或指令 。

> **选择题 3.1.2 中央处理器部件**
> 通常情况下，不包含在中央处理器（CPU)芯片中的部件是（）。
>
> * DRAM
> * ALU
> * 控制器
> * 寄存器
>
> 正确答案：DRAM 。
## 3.1.2 CPU执行过程

### 1. 简单执行过程

简单的了解了内存和CPU之后，我们就可以来看看程序代码是如何进一步被执行的。上面提到了，程序代码被读取到内存中了，现在要执行这段代码，那就需要CPU出马了，首先，CPU会去读取需要进行操作的数据，对了，看这代码：

```c
int main()
{
    int a = 5;
    int b = 3;
    int sum = 0;
    sum = a + b;
    return 0;
}
```

也就是需要读取数据a和b，那么读取到的数据a和b存放在哪了呢？根据我们上面对CPU简单的了解可知，数据a和b是被放到了CPU中的寄存器中了，看图3.1.4。

![图3.1.4 内存与CPU联动](https://ebook2023.oss-cn-shanghai.aliyuncs.com/图3.1.4 内存与CPU联动.png)

在CPU中有两个比较重要的组件就是运算器和寄存器，寄存器有很多个，再看内存，是一个个的小格子，每个格子有编号，比如说现在数据a和b分别存放在#1和#2上，然后CPU将他们读取放在寄存器R1和R2上，如图3.2.4所示。

CPU 本身只负责运算，不负责储存数据。数据一般都储存在内存之中，CPU 要用的时候就去内存读写数据。但是，CPU的运算速度远高于内存的读写速度，为了避免被拖慢，CPU都自带一级缓存和二级缓存。基本上，CPU缓存可以看作是读写速度较快的内存但是，CPU缓存还是不够快，另外数据在缓存里面的地址是不固定的，CPU每次读写都要寻址也会拖慢速度。因此，除了缓存之外，CPU 还自带了寄存器（register），用来储存最常用的数据。也就是说，那些最频繁读写的数据（比如循环变量），都会放在寄存器里面，CPU优先读写寄存器，再由寄存器跟内存交换数据。


 ![图3.1.5 从内存读数据至CPU寄存器](https://ebook2023.oss-cn-shanghai.aliyuncs.com/图3.1.5 从内存读数据至CPU寄存器.png)

这个时候就要计算a和b的和了，然后就轮到运算器出马了，它会拿到寄存器R1和R2，也就是拿到数据a和b，然后做加法运算。

![图3.1.6 运算器对寄存器中数据做运算](https://ebook2023.oss-cn-shanghai.aliyuncs.com/图3.1.6 运算器对寄存器中数据做运算.png)

那么计算之后的结果也就是sum，运算器会再次把它放到寄存器，比如R1中，这个时候之前的数据b就会被覆盖，如此一来，CPU和内存就一起完成一次加法运算操作。

这里其实我们把关注点聚焦到了加法运算操作，实际上，程序代码被装载进内存的时候会产生数据和指令两部分，数据我们都知道是啥，指令呢？

其实也好理解，指令就是说明程序该怎么执行，对于CPU来说就是告诉CPU该做什么，比如告诉CPU，读取数据a和b，然后再将他们相加，说白了，CPU是根据指令干活的，指令让怎么干，咱就怎么干。因此，你必须告诉CPU该干啥，否则，CPU也不清楚。

上面的简单介绍后，我们看看CPU主要做的四件事情：

* 从内存中读取数据，然后放到寄存器中

* 把寄存器中的数据写入到内存

* 进行数学运算和逻辑运算（加减乘除，AND,OR）

* 依据相应的条件进行跳转，执行其他指令（一条指令跳转到另外一条指令）

总的来说，就是我们写的程序是放在硬盘中的，在运行的时候才会被加载到内存中，也就是说内存中的数据都是从硬盘来的，而CPU中寄存器的数据又是从内存中装载进来的，然后CPU会根据相应的指令去操作寄存器中的数据，比如四则运算什么的，来完成一个程序在计算机中的运行。

### 2. 详解 a = 11 + 15 的执行过程

上面我们了解了基本的程序执行过程，接下来我们来看看如果用冯诺依曼模型执行a=11+15是一个怎样的过程。

我们再 Review 下这个问题：程序员写的程序a=11+15是字符串，CPU 不能执行字符串，只能执行指令。所以这里需要用到一种特殊的程序——编译器。编译器的核心能力是翻译，它把一种程序翻译成另一种程序语言。

这里，我们需要编译器将程序员写的程序翻译成 CPU 认识的指令（指令我们认为是一种低级语言，我们平时书写的是高级语言）。你可以先跟我完整地学完操作系统，再去深入了解编译原理的内容。

下面我们来详细阐述 a=11+15 的执行过程：

1.编译器通过分析，发现 11 和 15 是数据，因此编译好的程序启动时，会在内存中开辟出一个专门的区域存这样的常数，这个专门用来存储常数的区域，就是数据段，如下所示：

```
11 被存储到了地址 0x100;
15 被存储到了地址 0x104;
```

![图3.1.7 内存数据和程序存放示意图](https://ebook2023.oss-cn-shanghai.aliyuncs.com/图3.1.7 内存数据和程序存放示意图.png)

2.编译器将a=11+15转换成了 4 条指令，程序启动后，这些指令被导入了一个专门用来存储指令的区域，也就是正文段。如上图所示，这 4 条指令被存储到了 0x200-0x20c 的区域中：

```
0x200 位置的 load 指令将地址 0x100 中的数据 11 导入寄存器 R0；
0x204 位置的 load 指令将地址 0x104 中的数据 15 导入寄存器 R1；
0x208 位置的 add 指令将寄存器 R0 和 R1 中的值相加，存入寄存器 R2；
0x20c 位置的 store 指令将寄存器 R2 中的值存回数据区域中的 0x1108 位置
```

3.具体执行的时候，PC 指针先指向 0x200 位置，然后依次执行这 4 条指令。

> **选择题 3.1.3 Cache 结构的作用**
> 在多级存储体系中，“Cache（缓存）——内存”结构的作用是解决（）问题。
>
> * 内存容量不足
> * 内存与外存速度不匹配
> * 外存与CPU速度不匹配
> * 内存与CPU速度不匹配
>
> 正确答案：内存与CPU速度不匹配 。


>**选择题 3.1.4 CPU中通用寄存器位数**
>CPU中通用寄存器的位数取决于（）。
>
>* 存储器的容量
>* 指令的长度
>* 机器字长
>* 都不对
>
>正确答案：机器字长 。